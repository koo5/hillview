name: hillview

services:
  postgres:
    image: postgis/postgis:15-3.3
    container_name: hillview_postgres
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-hillview}
      POSTGRES_USER: ${POSTGRES_USER:-hillview}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-hillview}
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-hillview} -d ${POSTGRES_DB:-hillview}"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    restart: always
    build:
      context: .
      dockerfile: api/app/Dockerfile
    container_name: hillview_api
    ports:
      - "${API_PORT:-8055}:8055"
    volumes:
      - ./api/app:/app/app
      - ./common:/app/common
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-hillview}:${POSTGRES_PASSWORD:-hillview}@postgres:5432/${POSTGRES_DB:-hillview}
      #- REDIS_URL=redis://redis:6379/0
      - MAPILLARY_CLIENT_TOKEN_FILE=/run/secrets/mapillary_token
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-in-production}
      - UPLOAD_DIR=/app/uploads
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - ENABLE_MAPILLARY_CACHE=${ENABLE_MAPILLARY_CACHE:-true}
      - ENABLE_MAPILLARY_LIVE=${ENABLE_MAPILLARY_LIVE:-true}
      - USER_ACCOUNTS=${USER_ACCOUNTS:-true}
      - TEST_USERS=${TEST_USERS:-false}
      - DEBUG_ENDPOINTS=${DEBUG_ENDPOINTS:-false}
      # Configure uvicorn for development with reload
      - MODULE_NAME=app.api
      - VARIABLE_NAME=app
      - HOST=0.0.0.0
      - PORT=8055
      - DEV_MODE=${DEV_MODE:-}
      - NO_LIMITS=${NO_LIMITS:-}
    command: >
      bash -c "/app/prestart.sh && uvicorn app.api:app --host 0.0.0.0 --port 8055 $${DEV_MODE:+--reload}"
    secrets:
      - mapillary_token
    depends_on:
      postgres:
        condition: service_healthy

  worker:
    restart: always
    build:
      context: .
      dockerfile: worker/Dockerfile
    container_name: hillview_worker
    ports:
      - "${WORKER_PORT:-8056}:8056"
    volumes:
      - ./uploads:/app/uploads
      - pics:/app/pics
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-hillview}:${POSTGRES_PASSWORD:-hillview}@postgres:5432/${POSTGRES_DB:-hillview}
      - UPLOAD_DIR=/app/uploads
      - PICS_URL=${PICS_URL:-}
      - WORKER_PORT=8056
      - WORKER_HOST=0.0.0.0
      - API_URL=http://localhost:8055
    command: python app.py

volumes:
  postgres_data:
  pics:
    external: true
    name: pics


secrets:
  mapillary_token:
    file: ./secrets/MAPILLARY_CLIENT_TOKEN

networks:
  default:
    name: hillview_network
