# Database Migrations Guide

This guide covers the correct workflow for managing database migrations in the Hillview project using Alembic.

## Quick Reference

All migration commands should be run from the `/backend` directory using the migration script:

```bash
cd backend
./scripts/migrate.sh [alembic command]
```

## Common Commands

### Check Migration Status
```bash
# View current database migration version
./scripts/migrate.sh current

# View all available migration heads
./scripts/migrate.sh heads

# View complete migration history
./scripts/migrate.sh history
```

### Apply Migrations
```bash
# Apply all pending migrations
./scripts/migrate.sh upgrade head

# Upgrade to specific revision
./scripts/migrate.sh upgrade <revision_id>

# Downgrade one migration
./scripts/migrate.sh downgrade -1

# Downgrade to specific revision
./scripts/migrate.sh downgrade <revision_id>
```

### Create New Migrations
```bash
# After making changes to models in common/models.py:

# 1. Generate migration automatically
./scripts/migrate.sh revision --autogenerate -m "Description of changes"

# 2. Review the generated migration file in api/app/alembic/versions/

# 3. Apply the migration
./scripts/migrate.sh upgrade head

# 4. Verify database changes (optional)
docker exec -it hillview_postgres psql -U postgres -d hillview -c "\d tablename"
```

## Migration Script Details

The `./scripts/migrate.sh` script automatically handles:

- ✅ **Environment Loading**: Uses current `.env` file for database configuration
- ✅ **Docker Networking**: Connects to the correct Docker network
- ✅ **Volume Mounting**: Mounts backend directory correctly
- ✅ **Path Configuration**: Sets proper working directory 
- ✅ **Sync Mode**: Prevents async engine conflicts with `ALEMBIC_SYNC_MODE=1`

## Migration Best Practices

### Before Creating Migrations
1. **Make sure the API container is running** (for autogenerate to work properly):
   ```bash
   docker compose up -d api
   ```

2. **Always review autogenerated migrations** before applying:
   - Check that column types are correct
   - Verify foreign key constraints
   - Look for data migration needs
   - Ensure indexes are properly created

3. **Test migrations on development database first**

### Migration Naming Convention
Use descriptive names that indicate the change:
```bash
./scripts/migrate.sh revision --autogenerate -m "add_user_preferences_table"
./scripts/migrate.sh revision --autogenerate -m "add_photo_processing_status_column" 
./scripts/migrate.sh revision --autogenerate -m "create_indexes_for_geospatial_queries"
```

### Handling Migration Conflicts

If you encounter multiple heads or merge conflicts:

1. **Check current state**:
   ```bash
   ./scripts/migrate.sh heads
   ./scripts/migrate.sh current
   ```

2. **Create merge migration** (if multiple heads exist):
   ```bash
   ./scripts/migrate.sh merge -m "merge migration heads"
   ```

3. **Stamp database** (if migration tree is corrupted):
   ```bash
   ./scripts/migrate.sh stamp <target_revision_id>
   ```

## Troubleshooting

### Container Not Found Errors
```bash
# Make sure containers are running
docker compose up -d postgres api

# Check network name
docker network ls | grep hillview
```

### Import/Path Errors  
The migration script handles Python path issues automatically. If you see import errors, check:

1. Models are properly defined in `common/models.py`
2. Database connection is working: `curl http://localhost:8055/api/debug`

### Async Engine Conflicts
The script sets `ALEMBIC_SYNC_MODE=1` automatically to prevent async SQLAlchemy conflicts.

### Permission Errors
Make sure the migration script is executable:
```bash
chmod +x ./scripts/migrate.sh
```

## Database Schema Management

### Model Changes Workflow
1. Modify models in `common/models.py`
2. Generate migration: `./scripts/migrate.sh revision --autogenerate -m "description"`
3. Review generated SQL in the migration file
4. Test on development: `./scripts/migrate.sh upgrade head`
5. Commit both model changes and migration files

### Production Deployment
1. **Always backup production database first**
2. Test migrations on production-like data
3. Apply migrations during maintenance window:
   ```bash
   ./scripts/migrate.sh upgrade head
   ```
4. Verify application starts correctly after migration

## Files and Configuration

### Key Files
- `backend/scripts/migrate.sh` - Migration script (use this for all operations)
- `backend/api/app/alembic.ini` - Alembic configuration 
- `backend/api/app/alembic/env.py` - Migration environment setup
- `backend/api/app/alembic/versions/` - Individual migration files
- `backend/common/models.py` - SQLAlchemy model definitions

### Environment Variables
The migration script automatically loads from `backend/.env`:
- `DATABASE_URL` - PostgreSQL connection string
- Other database connection parameters

### Docker Configuration
- **Network**: `hillview_network` (auto-detected)
- **Container**: Uses `backend-api:latest` image
- **Working Directory**: `/app/api/app` (where alembic.ini is located)
- **Volume Mount**: `backend/` → `/app/`

## Advanced Operations

### Viewing SQL Without Applying
```bash
# Generate SQL for pending migrations
./scripts/migrate.sh upgrade head --sql

# Generate SQL for specific migration
./scripts/migrate.sh upgrade <revision> --sql
```

### Working with Branches
```bash
# Create branch
./scripts/migrate.sh revision -m "feature branch" --branch-label feature

# Upgrade specific branch
./scripts/migrate.sh upgrade feature@head
```

### Data Migrations
For complex schema changes requiring data transformation, create empty migration and add custom code:

```bash
# Create empty migration
./scripts/migrate.sh revision -m "migrate_user_data"
```

Then edit the migration file to add data transformation logic in the `upgrade()` function.

## Database Access

### Direct Database Connection
To connect directly to the PostgreSQL database for inspection or manual operations:

```bash
# Connect to database with psql
docker exec -it hillview_postgres psql -U hillview -d hillview

# Run single command
docker exec hillview_postgres psql -U hillview -d hillview -c "SELECT * FROM users LIMIT 5;"

# View table structure
docker exec hillview_postgres psql -U hillview -d hillview -c "\d photos"

# List all tables
docker exec hillview_postgres psql -U hillview -d hillview -c "\dt"
```

### Database Credentials
From docker-compose.yml and .env configuration:
- **Database**: `hillview` (from `POSTGRES_DB`)
- **Username**: `hillview` (from `POSTGRES_USER`) 
- **Password**: `hillview` (from `POSTGRES_PASSWORD`)
- **Host**: `hillview_postgres` (container name)
- **Port**: `5432` (internal), `5434` (external from `POSTGRES_PORT`)

### Common Database Commands
```bash
# Check database size
docker exec hillview_postgres psql -U hillview -d hillview -c "SELECT pg_size_pretty(pg_database_size('hillview'));"

# View migration history in database
docker exec hillview_postgres psql -U hillview -d hillview -c "SELECT * FROM alembic_version;"

# Check table row counts
docker exec hillview_postgres psql -U hillview -d hillview -c "
SELECT 
    schemaname,
    tablename,
    n_tup_ins - n_tup_del as row_count
FROM pg_stat_user_tables 
ORDER BY row_count DESC;"
```

## Getting Help

- Check migration history: `./scripts/migrate.sh history --verbose`
- View current database schema: `docker exec hillview_postgres psql -U hillview -d hillview -c "\dt"`
- Connect to database directly: `docker exec -it hillview_postgres psql -U hillview -d hillview`
- For complex issues, consider the [Alembic documentation](https://alembic.sqlalchemy.org/)