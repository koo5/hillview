name: hillview

services:

  postgres:
    init: true
    image: postgis/postgis:15-3.3
    container_name: hillview_postgres
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-hillview}
      POSTGRES_USER: ${POSTGRES_USER:-hillview}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-hillview}
      # Removed POSTGRES_HOST_AUTH_METHOD: trust - use password auth instead
    network_mode: host
    ports:
      - "${POSTGRES_PORT:-5434}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-hillview} -d ${POSTGRES_DB:-hillview}"]
      interval: 10s
      timeout: 5s
      retries: 5



  api:
    init: true
    restart: always
    build:
      context: backend
      dockerfile: api/app/Dockerfile
    container_name: hillview_api
    network_mode: host
    ports:
      - "${API_PORT:-8055}:8055"
    volumes:
      - ./backend/api/app:/app/app
      - ./backend/common:/app/common
      - pics:/app/pics
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-hillview}:${POSTGRES_PASSWORD:-hillview}@localhost:5432/${POSTGRES_DB:-hillview}
      #- REDIS_URL=redis://redis:6379/0
      - MAPILLARY_CLIENT_TOKEN_FILE=/run/secrets/mapillary_token
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-in-production}
      - UPLOAD_DIR=/app/uploads
      - PICS_DIR=/app/pics
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - ENABLE_MAPILLARY_CACHE=${ENABLE_MAPILLARY_CACHE:-true}
      - ENABLE_MAPILLARY_LIVE=${ENABLE_MAPILLARY_LIVE:-true}
      - USER_ACCOUNTS=${USER_ACCOUNTS:-true}
      - TEST_USERS=${TEST_USERS:-false}
      - DEBUG_ENDPOINTS=${DEBUG_ENDPOINTS:-false}
      # Configure uvicorn for development with reload
      - MODULE_NAME=app.api
      - VARIABLE_NAME=app
      - HOST=0.0.0.0
      - PORT=8055
      - DEV_MODE=${DEV_MODE:-}
      - NO_LIMITS=${NO_LIMITS:-}
      - WORKER_URL=${WORKER_URL:-http://localhost:8056}
      - PICS_URL=${PICS_URL:-}
      - BUCKET_NAME=${BUCKET_NAME:-}
      - CDN_BASE_URL=${CDN_BASE_URL:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_ENDPOINT_URL_S3=${AWS_ENDPOINT_URL_S3:-}
      #- FIREBASE_CONFIG=${FIREBASE_CONFIG:/run/secrets/firebase_config}
      - GOOGLE_APPLICATION_CREDENTIALS=/run/secrets/firebase_credentials
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:-}
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT:-}
    command: >
      bash -c "cd /app/app && /app/prestart.sh && uvicorn api:app --host 0.0.0.0 --port 8055 $${DEV_MODE:+--reload}"
    secrets:
      - mapillary_token
#      - firebase_config
      - firebase_credentials
    depends_on:
      postgres:
        condition: service_healthy


  worker:
    init: true
    restart: always
    build:
      context: backend
      dockerfile: worker/Dockerfile
    container_name: hillview_worker
    network_mode: host
    ports:
      - "${WORKER_PORT:-8056}:8056"
    volumes:
      - ./backend/worker:/app/worker
      - ./backend/common:/app/common
      - uploads:/app/uploads
      # - pics:/app/pics
    environment:
      - UPLOAD_DIR=/app/uploads
      #- PICS_DIR=/app/pics
      - PICS_URL=${PICS_URL:-}
      - WORKER_PORT=8056
      - WORKER_HOST=0.0.0.0
      - API_URL=http://localhost:8055/api
      - DEV_MODE=${DEV_MODE:-}
      - BUCKET_NAME=${BUCKET_NAME:-}
      - CDN_BASE_URL=${CDN_BASE_URL:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_ENDPOINT_URL_S3=${AWS_ENDPOINT_URL_S3:-}


  frontend:
    init: true
    restart: always
    build:
      context: frontend
      dockerfile: Dockerfile
    container_name: hillview_frontend
    network_mode: host
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=3000
      - VITE_BACKEND=http://localhost:8055/api
      - VITE_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - VITE_GOOGLE_REDIRECT_URI=${VITE_GOOGLE_REDIRECT_URI:-}
      - VITE_GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - VITE_GITHUB_REDIRECT_URI=${VITE_GITHUB_REDIRECT_URI:-}
      - VITE_FEATURE_USER_ACCOUNTS=${USER_ACCOUNTS:-true}
      - VITE_DEV_MODE=${DEV_MODE:-false}
      - VITE_SENTRY_ENABLED=${VITE_SENTRY_ENABLED:-false}
      - VITE_SENTRY_DSN=${VITE_SENTRY_DSN:-}
    depends_on:
      postgres:
        condition: service_healthy
      api:
        condition: service_started


volumes:
  postgres_data:
  uploads:
  pics:
    external: true
    name: pics


secrets:
  mapillary_token:
      file: ./secrets/MAPILLARY_CLIENT_TOKEN
  firebase_config:
      file: ./secrets/FIREBASE_CONFIG.json
  firebase_credentials:
      file: ./secrets/firebase_credentials


networks:
  default:
    name: hillview_network
